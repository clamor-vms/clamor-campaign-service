{
    "Title": "Skaioskit Operation Service",
    "Commands": {
        "_build": {
            "Requires": [],
            "Steps": [
                {
                    "Type": "RunCommand",
                    "Args": {
                        "Command": [
                            "docker",
                            "run",
                            "--rm",
                            "-v",
                            "${DIR}/src:/go/src/skaioskit",
                            "-w",
                            "/go/src/skaioskit",
                            "lushdigital/docker-golang-dep",
                            "ensure"
                        ]
                    }
                },
                {
                    "Type": "RunCommand",
                    "Args": {
                        "Command": [
                            "docker",
                            "run",
                            "--rm",
                            "-v",
                            "${DIR}/src:/go/src/skaioskit",
                            "-w",
                            "/go/src/skaioskit",
                            "golang:latest",
                            "go",
                            "build",
                            "-ldflags",
                            "-linkmode external -extldflags -static",
                            "-o",
                            "operation"
                        ]
                    }
                }
            ]
        },

        "_pack": {
            "Requires": [],
            "Steps": [
                {
                    "Type": "RunCommand",
                    "Args": {
                        "Command": [
                            "docker",
                            "build",
                            "-f",
                            "./Dockerfile",
                            "-t",
                            "localhost:5000/skaioskit/operation-service",
                            "."
                        ]
                    }
                }
            ]
        },

        "_upload": {
            "Requires": [],
            "Steps": [
                {
                    "Type": "RunCommand",
                    "Args": {
                        "Command": [
                            "docker",
                            "push",
                            "localhost:5000/skaioskit/operation-service"
                        ]
                    }
                }
            ]
        },

        "build": {
            "Requires": ["_build", "_pack", "_upload"],
            "Steps": []
        },
        
        "deploy": {
            "Requires": ["build"],
            "Steps": [
                {
                    "Type": "EnsureSecret",
                    "Args": {
                        "Key": "skaioskit-operation-service-mysql-password"
                    }
                },
                {
                    "Type": "EnsureSecret",
                    "Args": {
                        "Key": "skaioskit-operation-service-mysql-root-password"
                    }
                },
                {
                    "Type": "CopyFile",
                    "Args": {
                        "Source": "k8s/deployment.template.yaml",
                        "Target": "deployment.yaml"
                    }
                },
                {
                    "Type": "RunTemplate",
                    "Args": {
                        "File": "deployment.yaml"
                    }
                },
                {
                    "Type": "DoublePipeCommand",
                    "Args": {
                        "Source": [
                            "cat",
                            "deployment.yaml"
                        ],
                        "Target1": [
                            "envsubst"
                        ],
                        "Target2": [
                            "kubectl",
                            "apply",
                            "-f",
                            "-"
                        ]
                    }
                }
            ]
        },

        "run": {
            "Requires": ["_build", "_pack"],
            "Steps": [
                {
                    "Type": "RunCommand",
                    "Args": {
                        "Command": [
                            "./src/operation",
                            "serve"
                        ]
                    }
                }
            ]
        },

        "stop": {
            "Requires": [],
            "Steps": [
                {
                    "Type": "RunCommand",
                    "Args": {
                        "Command": [
                            "kubectl",
                            "delete",
                            "deployments,services,pods,pv,pvc,cronjob,job",
                            "--all"
                        ]
                    }
                }
            ]
        },

        "clean": {
            "Requires": [],
            "Steps": [
                {
                    "Type": "RunCommand",
                    "Args": {
                        "Command": [
                            "rm",
                            "-rf",
                            "${DIR}/working/mysql"
                        ]
                    }
                }
            ]
        }
    }
}
